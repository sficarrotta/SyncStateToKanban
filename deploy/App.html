<!DOCTYPE html>
<html>
<head>
    <title>SyncFields</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var Ext=window.Ext4||window.Ext;window.console=window.console||function noop(){},Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",kanbanStateField:"KanbanState",KanbanToStateMap:{Prioritized:"Defined","In Dev":"In-Progress","In Test":"In-Progress","Ready For Acceptance":"Completed",Accepted:"Accepted","Electronic Sign-off":"Accepted"},StateToKanbanMap:{Defined:"Prioritized","In-Progress":"In Dev",Completed:"Ready For Acceptance",Accepted:"Accepted"},launch:function(){this.iterationCombobox=this.add({xtype:"rallyiterationcombobox",listeners:{ready:this._onIterationComboboxLoad,change:this._onIterationComboboxChanged,scope:this}})},_onIterationComboboxLoad:function(){var query=this.iterationCombobox.getQueryFromSelected();this._loadStories(query)},_onIterationComboboxChanged:function(){var store=this._myGrid.getStore();store.clearFilter(!0),store.filter(this.iterationCombobox.getQueryFromSelected())},_loadStories:function(query){console.log("Loading stories"),Ext.create("Rally.data.WsapiDataStore",{model:"User Story",autoLoad:!0,filters:query,listeners:{load:function(store,records,success){console.log("Loaded Store with %i records",records.length),this._updateKanbanState(store,records)},update:function(store,rec,modified,opts){console.log("data updated"),this._updateKanbanState(store,rec)},scope:this},fetch:["FormattedID","Name","Owner","ScheduleState","KanbanState"]})},_updateKanbanState:function(store,rec){var me=this;Ext.Array.each(rec,function(story){var state=story.get("ScheduleState"),kbState=story.get(me.kanbanStateField);console.log("state: ",state),console.log("kbstate:",kbState);var mappedKbState=me.StateToKanbanMap[state];console.log("Mapped KB State: ",mappedKbState),kbState!=mappedKbState&&(console.log("Mismatch found"),story.set(me.kanbanStateField,mappedKbState))}),this._updateGrid(store)},_createGrid:function(myStore){console.log("Creating grid",myStore),this._myGrid=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygrid",title:"Sync Stories",height:"98%",store:myStore,columnCfgs:["FormattedID","Name","ScheduleState","KanbanState","Owner"]}),this.add(this._myGrid);var celledit=this._myGrid.plugins[0],oldPub=celledit.publish,newPub=function(event,varargs){"objectupdate"!==event&&oldPub.apply(this,arguments)};celledit.publish=Ext.bind(newPub,celledit)},_updateGrid:function(myStore){void 0===this._myGrid?this._createGrid(myStore):this._myGrid.reconfigure(myStore)}});

            Rally.launchApp('CustomApp', {
                name:"SyncFields",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
